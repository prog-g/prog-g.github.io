---
layout: post
title: そうだChrome拡張つくってみよう
tag: [Web, 岐大祭2020]
---

普段使っている大学のLMS(教員が講義資料を配布したり学生が課題を提出したりするのに使われるWebアプリ)にちょっと不便だなーという点があったので、それを解決するChrome拡張機能を思いつきでつくってみた。開発からChromeWebストアへの公開まで一通りやったので、その流れやつくったものについて紹介する。

## 完成品
Drag and Drop Extension for AIMSという名前で[ChromeWebストア](https://chrome.google.com/webstore/detail/drag-and-drop-extension-f/klbkinefgmmgbfgdblaflhcfobacebpn)にて公開している。(名前が長いので何とかしたい。)

今回作ったのは課題を提出するページにて、学生が課題のPDFファイルなどを提出ページにドラッグアンドドロップするだけでアップロードできるようにするという拡張機能。ドラッグアンドドロップでアップロードすること自体はブラウザの標準機能でも一応可能だが、それでもこの拡張機能が必要な理由は以下の比較を見ていただければわかるだろう。

#### 拡張なしの素の状態
素の状態でドラッグアンドドロップする場合、赤枠の狭い範囲にしかドロップできない上にファイルをドラッグしても「ファイルを選択」ボタンの色がほんの僅かに変化するだけで非常にわかりにくい。筆者自身もこの拡張機能を作ろうと思った段階では標準機能でドラッグアンドドロップできることを知らなかった。
![拡張を使わない場合のスクリーンショット]({{ "/assets/2020/chrome拡張_1.png" | relative_url }})

#### 拡張機能を導入後
課題提出の画面を開くと画像のような枠が追加される。ここにファイルをドラッグすると...
![拡張機能導入後のスクリーンショット1]({{ "/assets/2020/chrome拡張_2.png" | relative_url }})


このように枠が水色に変化しドロップできることがわかりやすい。
![拡張機能導入後のスクリーンショット2]({{ "/assets/2020/chrome拡張_3.png" | relative_url }})


## そもそも拡張機能って何するの
筆者自身も拡張機能でできることを完全に把握しているわけではないが、語弊を恐れずざっくり言えば「ユーザーがブラウザで開いた任意のWebサイトのHTMLに対して自作のCSSやJSを実行してHTMLを操作できるモノ」だと思う。(実際にはもっと色々なことができるらしい。)今回作った拡張機能の場合は、

 1. ```https://aims2.gifu-u.ac.jp/courses/*```にマッチするURLのWebサイトで、
 2. ```submission_attachment```というクラスを持つ要素が存在する場合、
 3. その要素の中に、予め用意したファイルをドロップするための枠にあたる要素を追加する
 4. 追加した要素にドラッグアンドドロップした際のCSSの切り替えやファイルを扱う処理を行うEventListenerを追加する

といった処理をJavascriptで記述することで実現している。(正確には1は後述するmanifest.jsonに、2~4はJSに記述している。)

## 拡張の開発
### ファイルを用意する
##### manifest.json
 拡張機能の名前やJS,CSS,アイコン画像等のパス、どのURLのWebサイトで拡張機能を動かすのか、ユーザーに要求する権限などを記述するjsonファイル。
##### アイコン画像
 拡張機能を追加した際にアドレスバーの横に表示されるアイコン。16,48,128px四方の3種類用意すると良い。とりあえずInkscapeで適当に作った。
##### contents.js
 上記の処理をここに記述している。ファイル名は何でも良い。
##### style.css
 JSで追加するドロップ枠部分のスタイルを指定している。

以上の4点(JSとCSSは拡張機能の内容によって有無が変わる)を用意すれば最低限自分の手元のデバイスで動作させることができる。自分専用の拡張機能の場合はここまでで完成でも良いだろう。

### ストアに掲載する
作成した拡張機能を他の人にも使ってもらいたい場合はChromeWebストアに掲載する必要がある。以前はここ以外のWebサイトからインストールできるAPIが用意されていたようだが2018年に廃止された。掲載方法についても詳しく解説している記事が豊富なため詳細な手順は割愛し、「意外とそれらの記事で触れられていないものの個人的に気になると思ったポイント」のみお伝えする。

###### ストア掲載にはお金がかかる
ChromeWebストアに掲載するにはデベロッパー登録が必要となり、最初に5ドルの登録料を支払う必要がある。1アカウントにつき1回だけ請求されるのでどれだけ拡張機能を公開しても追加費用は発生しない。以前はURL限定公開や非公開の場合は登録料が不要だったため、その頃の記事には料金不要と書いてあったりするので注意されたい。ちなみに支払いにPayPalは利用できなかった。
###### 拡張機能のアップロード
用意した各種ファイルはまとめてzipに固めてアップロードする。
###### ストアでの公開方法
公開方法は一般公開,URL限定公開,指定ユーザーにのみ利用可能(非公開)の3パターンを任意に切り替えできる。
非公開にした場合は、自分で指定したGoogleアカウントの持ち主のみ拡張機能を利用できる。1人ずつアカウントを指定する以外にも、自分が所有するGoogleグループやGoogleWorkspaceのドメイン内にのみ公開することもできる。
###### 公開方法に関わらず審査が入る
公開には審査が必要となる。初回はもちろん、拡張機能の中身やWebストアでの設定を変更する場合(公開方法の切り替えを含む)も審査が行われる。審査は今回開発した極めて小規模なものでも毎回2~3日かかった。審査に出している最中はWebストアの設定や掲載する情報の編集ははできない。(審査中は実質作業が止まるため、審査提出は計画的に。)

###### 公開後のWebストア上のURL
審査を通過するとChromeWebストアに拡張機能が掲載されるのだが、その掲載ページのURLがどこにあるのかわからず探したので一応紹介。「ストアの掲載情報」という項目名からしてこの下のほうにリンクがありそうだが無い。実はデベロッパーダッシュボード内のタイトル部分がそのままWebストアへのリンクとなっている。
![拡張を使わない場合のスクリーンショット]({{ "/assets/2020/chrome拡張_4.png" | relative_url }})

## まとめ
審査が入ったり登録料が必要だったりとWebストアの申請周りの敷居が少々高いのがデメリットではあるが、日々のちょっとした不便の解消に週末DIY的な感覚でやってみると案外楽しいので是非オレオレ拡張機能をつくってみてはいかがだろうか。
